% function result = fh(K22, baseDH, Data1)
% % fh - 适应度函数：利用误差补偿向量 K22 修正 DH 参数后计算误差
% %
% %   result = fh(K22, baseDH, Data1)
% %
% % 输入参数：
% %   K22     : 6 维误差补偿量（待优化变量）。
% %   baseDH  : 原始 DH 参数（24×1 列向量）。
% %   Data1   : 实验数据，前6列为关节角（单位：度），第7列为测量值（例如距离，单位：mm）。
% %
% % 说明：
% %   误差补偿向量 K22 仅作用于基础 DH 参数的最后 6 个元素，
% %   因此补偿向量 R12 定义为 [zeros(18,1); K22]，整体修正后的 DH 参数为：
% %
% %         compDH = baseDH + R12.
% %
% %   使用修正后的 DH 参数，通过正向运动学函数 DH 计算输出，
% %   并对数据集中每组测量计算预测输出与实际测量值的误差，
% %   此处的目标函数采用所有测量数据中最大的平方误差作为适应度输出。
% %
% % 输出：
% %   result  : 目标函数值，这里取最大平方误差；也可以改为均方误差。
% 
% % 标定点（用于正向运动学计算）
% P0 = [0.24500; -0.45600; 0.00665];
% 
% % 数据预处理：将角度转换为弧度，将测量值由 mm 转为 m
% U   = Data1(:, 1:6) * pi/180;
% MM1 = Data1(:, 7) / 1000;
% 
% % 构造补偿向量：前18个值保持为0，后6个参数为 K22
% R12 = [zeros(18,1); K22(:)];
% 
% % 计算补偿后的 DH 参数
% compDH = baseDH + R12;
% 
% % 初始化误差累积与最大误差
% sum_err = 0;
% E_max2  = 0;
% 
% % 遍历所有测量数据
% for k = 1:size(U,1)
%     % 当前测量的关节角（列向量）
%     q = U(k, :)';
%     % 实测的末端输出值（例如距离）
%     L_ex_val = MM1(k);
% 
%     % 利用修正后的 DH 参数计算正向运动学输出
%     L_norm = DH(compDH, q, P0);
% 
%     % 计算当前测量的平方误差
%     err = (norm(L_ex_val - L_norm))^2;
% 
%     % 累加均方误差
%     sum_err = sum_err + err;
% 
%     % 记录最大平方误差
%     if err > E_max2
%         E_max2 = err;
%     end
% end
% 
% % 这里的目标函数可以设计为：
% % ① 最大平方误差
% result = E_max2;
% % ② 均方误差（取消下面的注释即可）
% % result = sum_err / size(U,1);
% 
% end

function result = fh(K22, baseDH, Data1)
% fh - 适应度函数：利用24维误差补偿向量K22修正DH参数后计算误差
%
%   result = fh(K22, baseDH, Data1)
%
% 输入参数：
%   K22     : 24维误差补偿量（待优化变量），用于对所有DH参数进行补偿。
%   baseDH  : 原始DH参数（24×1列向量）。
%   Data1   : 实验数据，前6列为关节角（单位：度），第7列为测量值（例如距离，单位：mm）。
%
% 说明：
%   误差补偿向量K22直接作用于全部DH参数，从而补偿后的DH参数为：
%
%         compDH = baseDH + K22.
%
%   使用补偿后的DH参数，通过正向运动学函数DH计算末端输出，
%   并对数据集中每组测量计算预测输出与实际测量值之间的误差，
%   此处目标函数采用所有测量数据中最大的平方误差作为适应度输出；
%   如果需要，也可以取消注释采用均方误差。
%
% 输出：
%   result  : 目标函数值。

% 标定点（用于正向运动学计算）
P0 = [0.24500; -0.45600; 0.00665];

% 数据预处理：将角度转换为弧度，将测量值由mm转换为m
U   = Data1(:, 1:6) * pi/180;
MM1 = Data1(:, 7)   / 1000;

% 误差补偿向量：K22直接为24×1向量（注意K22应为行向量时转换为列向量）
R12 = K22(:);

% 计算补偿后的DH参数
compDH = baseDH + R12;

% 初始化累积误差与最大误差
sum_err = 0;
E_max2  = 0;

% 遍历所有测量数据
for k = 1:size(U,1)
    % 当前测量点的关节角（列向量）
    q = U(k, :)';
    % 实测末端输出（例如距离）
    L_ex_val = MM1(k);
    
    % 利用修正后的DH参数计算正向运动学输出
    L_norm = DH(compDH, q, P0);
    
    % 计算当前测量的平方误差
    err = (norm(L_ex_val - L_norm))^2;
    
    % 累加求和（可用于均方误差）
    sum_err = sum_err + err;
    
    % 记录最大平方误差
    if err > E_max2
        E_max2 = err;
    end
end

% 这里目标函数可以设计为：
% ① 最大平方误差：
result = E_max2;
% ② 均方误差（则取消下面注释即可）：
% result = sum_err / size(U,1);

end